@using Core.Domain.Common.Enumerations
@model ReservationListViewModel;
<div class="container">
    <header class="mb-3">
        <h1>Bulk Rejection</h1>
    </header>

    <div id="action-buttons" class="mb-3">
        <form asp-action="Reject" method="post">
            <input id="reservationIds" name="reservationIds" type="hidden">
            <button id="reject" type="submit" class="btn btn-danger">Reject</button>
        </form>
    </div>

    <table class="table table-hover" id="index-table">
        <thead>
            <tr>
                <th scole="col"><span class="d-none">선택</span></th>
                <th scope="col">좌석</th>
                <th scope="col">예약 신청 시간</th>
                <th scope="col">승인 상태</th>
                <th scope="col">예약자</th>
                <td scope="col" data-dt-order="disable"></td>
            </tr>
        </thead>
        <tbody>
            @foreach (var reservation in Model.Items)
            {
                <tr data-status="@reservation.ReservationStatus">
                    <td scope="row">
                        <span class="d-none">@reservation.ReservationId</span>
                    </td>
                    <td>
                        @reservation.SeatNumbers
                    </td>
                    <td>
                        <time datetime="@reservation.ReservedAtParameter">@reservation.ReservedAtDisplay</time>
                    </td>
                    <td>
                        @if (reservation.ReservationStatus == ReservationStatus.ReservationConfirmed)
                        {
                            <span>
                                <i class="bi bi-check-circle-fill text-success"></i>
                                승인됨
                            </span>
                        }
                        else if (reservation.ReservationStatus == ReservationStatus.ReservationRejected)
                        {
                            <span>
                                <i class="bi bi-ban-fill text-danger"></i>
                                거절됨
                            </span>
                        }
                        else
                        {
                            <span>
                                <i class="bi bi-hourglass-split text-secondary"></i>
                                승인 대기 중
                            </span>
                        }
                    </td>
                    <td>
                        @reservation.Name
                    </td>
                    <td>
                        <a asp-action="Details" asp-route-reservationId="@reservation.ReservationId">상세 보기</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@section Styles
{
    <link href="https://cdn.datatables.net/v/bs5/dt-2.3.2/sl-3.0.1/datatables.min.css" rel="stylesheet" integrity="sha384-vKpZSS3SMUjQu3fJQnU1tQD0j+0b3asU6w42bFIUJ+jzaEKGjamW/s7IiLDnoZES" crossorigin="anonymous">
}

@section Scripts
{
    <script defer src="https://cdn.datatables.net/v/bs5/dt-2.3.2/sl-3.0.1/datatables.min.js" integrity="sha384-oR152peSCPCKnUMWgxu58ydkSvhCdmp2eB4rMFcNcNmutqU1DOn6qMCay8AiNI/K" crossorigin="anonymous"></script>
    <script>
        window.addEventListener("load", function() {
            var table = new DataTable("#index-table", {
                columnDefs: [
                    {
                        orderable: false,
                        render: DataTable.render.select(),
                        targets: 0,
                    },
                ],
                language: {
                    emptyTable: "아직 예약된 좌석이 없습니다.",
                    select: {
                        aria: {
                            headerCheckbox: "전체 선택",
                            rowCheckbox: "선택",
                        },
                    },
                    zeroRecords: "검색 결과가 없습니다",
                },
                layout: {
                    topStart: $("#action-buttons"),
                    topEnd: null,
                    bottomStart: null,
                    bottomEnd: null,
                },
                order: [[2, 'asc']],
                ordering: {
                    indicators: false,
                },
                paging: false,
                select: {
                    selectable: (_, tr) => $(tr).data("status") === "@ReservationStatus.AwaitingPayment",
                    style: "multi",
                },
            });

            // Reject selected logic
            $("#reject").click((e) => {
                var selectedRows = table.rows({ selected: true }).data().toArray();
                var selectedIds = selectedRows.map(row => parseInt($(row[0]).text()));
                $("#reservationIds").val(selectedIds);

                if (selectedIds.length === 0) {
                    e.preventDefault();
                    return false;
                }
            });

            window.table = table;
        });
    </script>
}
