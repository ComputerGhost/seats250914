@using Core.Domain.Common.Enumerations
@model ReservationListViewModel;
<div class="container">
    <header class="mb-3">
        <h1>예약 목록</h1>
    </header>
    
    <p>이 페이지는 실시간으로 갱신되지 않으므로, 최신 정보를 확인하려면 새로고침하세요.</p>

    <ul class="nav nav-tabs" id="tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button
                class="nav-link active"
                id="seats-tab"
                data-bs-toggle="tab"
                data-bs-target="#seats-tab-pane"
                type="button"
                role="tab"
                aria-controls="seats-tab-pane"
                aria-selected="true"
            >좌석목록</button>
        </li>
        <li class="nav-item" role="presentation">
            <button
                class="nav-link"
                id="map-tab"
                data-bs-toggle="tab"
                data-bs-target="#map-tab-pane"
                type="button"
                role="tab"
                aria-controls="map-tab-pane"
                aria-selected="false"
            >좌석 배치도</button>
        </li>
    </ul>

    <div class="tab-content border border-top-0 p-3">

        <section
            class="tab-pane fade show active"
            id="seats-tab-pane"
            role="tabpanel"
            aria-labelledby="seats-tab"
            tabindex="0"
        >

            <div id="action-buttons" class="mb-3">
                <form asp-action="Approve" method="post">
                    <input id="reservationIds" name="reservationIds" type="hidden">
                    <button id="approve" type="submit" class="btn btn-success">선택한 예약 승인</button>
                </form>
            </div>

            <div id="search-input-group" class="input-group">
                <span class="input-group-text">
                    <i id="search-label" class="bi bi-search" role="img" aria-label="검색"></i>
                </span>
                <input asp-for="Search" type="search" class="form-control" aria-labelledby="search-label">
            </div>

            <table class="table table-hover" id="index-table">
                <thead>
                    <tr>
                        <th scole="col"><span class="d-none">선택</span></th>
                        <th scope="col">좌석</th>
                        <th scope="col">예약 신청 시간</th>
                        <th scope="col">승인 상태</th>
                        <th scope="col">예약자</th>
                        <td scope="col" data-dt-order="disable"></td>
                    </tr>
                    <tr>
                        <th colspan="7" data-dt-order="disable">
                            <a asp-action="Create" class="btn btn-outline-primary w-100">좌석 예약하기</a>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var reservation in Model.Items)
                    {
                        <tr data-status="@reservation.ReservationStatus">
                            <td scope="row">
                                <span class="d-none">@reservation.ReservationId</span>
                            </td>
                            <td>
                                @reservation.SeatNumbers
                            </td>
                            <td>
                                <time datetime="@reservation.ReservedAtParameter">@reservation.ReservedAtDisplay</time>
                            </td>
                            <td>
                                @if (reservation.ReservationStatus == ReservationStatus.ReservationConfirmed)
                                {
                                    <span>
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                        승인됨
                                    </span>
                                }
                                else if (reservation.ReservationStatus == ReservationStatus.ReservationRejected)
                                {
                                    <span>
                                        <i class="bi bi-ban-fill text-danger"></i>
                                        거절됨
                                    </span>
                                }
                                else
                                {
                                    <span>
                                        <i class="bi bi-hourglass-split text-secondary"></i>
                                        승인 대기 중
                                    </span>
                                }
                            </td>
                            <td>
                                @reservation.Name
                            </td>
                            <td>
                                <a asp-action="Details" asp-route-reservationId="@reservation.ReservationId">상세 보기</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </section>

        <section
            class="tab-pane fade"
            id="map-tab-pane"
            role="tabpanel"
            aria-labelledby="map-tab"
            tabindex="0"
        >
            <img class="img-fluid" src="~/images/seat-map.webp" alt="좌석 배치도" aria-label="좌석 배치도">
        </section>

    </div>
</div>

@section Styles
{
    <link href="https://cdn.datatables.net/v/bs5/dt-2.3.2/sl-3.0.1/datatables.min.css" rel="stylesheet" integrity="sha384-vKpZSS3SMUjQu3fJQnU1tQD0j+0b3asU6w42bFIUJ+jzaEKGjamW/s7IiLDnoZES" crossorigin="anonymous">
}

@section Scripts
{
    <script defer src="https://cdn.datatables.net/v/bs5/dt-2.3.2/sl-3.0.1/datatables.min.js" integrity="sha384-oR152peSCPCKnUMWgxu58ydkSvhCdmp2eB4rMFcNcNmutqU1DOn6qMCay8AiNI/K" crossorigin="anonymous"></script>
    <script>
        window.addEventListener("load", function() {
            var table = new DataTable("#index-table", {
                columnDefs: [
                    {
                        orderable: false,
                        render: DataTable.render.select(),
                        targets: 0,
                    },
                ],
                language: {
                    emptyTable: "아직 예약된 좌석이 없습니다.",
                    select: {
                        aria: {
                            headerCheckbox: "전체 선택",
                            rowCheckbox: "선택",
                        },
                    },
                    zeroRecords: "검색 결과가 없습니다",
                },
                layout: {
                    topStart: $("#action-buttons"),
                    topEnd: $("#search-input-group"),
                    bottomStart: null,
                    bottomEnd: null,
                },
                order: [[2, 'asc']],
                ordering: {
                    indicators: false,
                },
                paging: false,
                select: {
                    selectable: (_, tr) => $(tr).data("status") === "@ReservationStatus.AwaitingPayment",
                    style: "multi",
                },
            });

            $("#Search").on("keyup", function () {
                table.search(this.value).draw();
            });

            // Initial search of what is prefilled in the search box.
            table.search($("#Search").val()).draw();

            // Approve selected logic
            $("#approve").click((e) => {
                var selectedRows = table.rows({ selected: true }).data().toArray();
                var selectedIds = selectedRows.map(row => parseInt($(row[0]).text()));
                $("#reservationIds").val(selectedIds);
            });

            window.table = table;
        });
    </script>
}
